<div class="field">
  <div class="control">
    <button 
      class="validating-button button is-primary {styleClass}"
      class:is-loading={state === 'busy'}
      disabled={!enabled}
      ga-on={gaOn}
      ga-event-category={gaEventCategory}
      ga-event-action={gaAction}
      ga-event-label={gaEventLabel}
      on:click={execute}>
      {#if state === 'ready'}
      <span>
        {text}
      </span>
      {:else if state === 'finished'}
        <CheckIcon />
      {/if}
    </button>
  </div>
</div>

<script>
  import { CheckIcon } from 'svelte-feather-icons'

  let state = 'ready'

  export let text = 'Button'
  export let gaOn = null
  export let gaEventCategory = null
  export let gaAction = null
  export let gaEventLabel = null
  export let styleClass = 'is-medium by-medium is-fullwidth'

  export let enabled = true
  export let once = false
  export let action

  export function reset () {
    enabled = true
    state = 'ready'
  }

  function busy () {
    enabled = false
    state = 'busy'
  }

  function finished () {
    state = 'finished'
  }

  async function execute () {
    busy()
    try {
      await action()
      return once ? finished() : reset()
    } catch (e) {
      reset()
    }
  }

</script>